<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Philadelphia Parcels Map with Popups</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css" />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
        
        /* Combined Control Panel */
        .layer-control {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 13px;
            z-index: 10;
            min-width: 220px;
            max-width: 90vw;
        }

        .layer-control h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        
        .layer-control h3:hover {
            opacity: 0.8;
        }
        
        .control-section {
            margin-bottom: 12px;
        }
        
        .control-section:last-child {
            margin-bottom: 0;
        }
        
        .section-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .style-select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-family: inherit;
        }
        
        .style-select:hover {
            border-color: #3498db;
        }
        
        .style-select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }

        .toggle-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 4px;
            display: block;
            color: #2c3e50;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            min-width: 24px;
            min-height: 24px;
        }
        
        .toggle-btn:hover {
            background: rgba(0,0,0,0.05);
            border-radius: 4px;
        }
        
        .toggle-btn:active {
            opacity: 0.6;
        }

        .layer-content {
            display: block;
        }
        
        .layer-control.collapsed .layer-content {
            display: none;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .layer-control {
                top: 10px;
                left: 10px;
                right: auto;
                min-width: auto;
                max-width: calc(100vw - 70px);
                padding: 8px 12px;
                z-index: 10;
            }

            .toggle-btn {
                display: block;
                color: #2c3e50;
                font-size: 22px;
                width: 28px;
                height: 28px;
                line-height: 24px;
                text-align: center;
                flex-shrink: 0;
            }

            .layer-control.collapsed .layer-content {
                display: none;
            }

            .layer-control.collapsed {
                padding: 8px 12px;
                min-width: 140px;
            }

            .layer-control h3 {
                margin: 0;
                font-size: 14px;
                font-weight: 600;
            }

            .control-section {
                margin-bottom: 10px;
            }

            .section-label {
                font-size: 11px;
                margin-bottom: 6px;
            }

            .layer-toggle {
                margin: 6px 0;
            }

            .layer-control hr {
                margin: 10px 0 !important;
            }

            .layer-control button {
                font-size: 12px !important;
                padding: 6px !important;
            }
            
            .style-select {
                font-size: 16px;
                padding: 10px;
            }
        }
        
        .layer-toggle {
            display: flex;
            align-items: center;
            margin: 6px 0;
            cursor: pointer;
        }
        
        .layer-toggle input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }
        
        .layer-toggle label {
            cursor: pointer;
            user-select: none;
        }
        
        /* Professional popup table styles */
        /* Override Mapbox popup default styles */
        .mapboxgl-popup {
            max-width: none !important;
        }
        
        .mapboxgl-popup-content {
            max-width: none !important;
            width: 400px !important;
            min-width: 400px !important;
            padding: 0 !important;
            border-radius: 8px !important;
        }
        
        /* Mobile popup optimization */
        @media (max-width: 768px) {
            .mapboxgl-popup-content {
                width: calc(100vw - 20px) !important;
                min-width: calc(100vw - 20px) !important;
                max-width: calc(100vw - 20px) !important;
            }
            
            .popup-container {
                width: 100% !important;
                max-width: 100% !important;
            }
            
            .popup-container.compact {
                max-height: 200px !important;
            }
            
            .popup-container.compact .scrollable-content {
                max-height: 80px !important;
                overflow: hidden !important;
                flex: none !important;
            }
            
            .popup-container.compact .property-group:not(:first-child) {
                display: none !important;
            }
            
            .popup-container.compact .group-content {
                max-height: 50px !important;
                overflow: hidden !important;
            }
            
            .popup-container.compact .group-table tr:nth-child(n+4) {
                display: none !important;
            }
            
            .property-table {
                width: 100% !important;
            }
            
            .group-table {
                width: 100% !important;
            }
        }
        
        .mapboxgl-popup-tip {
            border-top-color: #ffffff !important;
            border-bottom-color: #ffffff !important;
        }
        
        .popup-container {
            width: 400px;
            max-width: 400px;
            max-height: 500px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 13px;
            line-height: 1.4;
            display: flex;
            flex-direction: column;
            padding: 16px;
            box-sizing: border-box;
        }
        
        .popup-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #3498db;
        }
        
        .property-table {
            width: 360px;
            border-collapse: collapse;
            margin: 8px 0;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 6px;
            overflow: hidden;
        }
        
        .property-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .property-table tr:hover {
            background-color: #e3f2fd;
        }
        
        .property-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
        }
        
        .property-table td:first-child {
            font-weight: 600;
            color: #495057;
            width: 40%;
            background-color: #f8f9fa;
        }
        
        .property-table td:last-child {
            color: #212529;
        }
        
        .property-table tr:last-child td {
            border-bottom: none;
        }
        
        .selection-card {
            border: 1px solid #dee2e6;
            margin: 8px 0;
            padding: 12px;
            background: #ffffff;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .selection-card:hover {
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);
            transform: translateY(-1px);
        }
        
        .selection-card-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .selection-card-subtitle {
            color: #6c757d;
            font-size: 12px;
            margin-bottom: 6px;
        }
        
        .selection-card-hint {
            color: #868e96;
            font-size: 11px;
            font-style: italic;
        }
        
        .popup-button {
            padding: 8px 16px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            margin-top: 12px;
            transition: all 0.2s ease;
        }
        
        .popup-button:hover {
            background: linear-gradient(135deg, #2980b9, #1f5f8b);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .popup-expand-btn {
            display: none;
            width: 100%;
            padding: 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            margin-top: 10px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .popup-expand-btn:active {
            background: #2980b9;
            transform: scale(0.98);
        }
        
        @media (max-width: 768px) {
            .popup-expand-btn {
                display: block;
            }
        }
        
        .scrollable-content {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 4px;
            flex: 1;
            min-height: 0;
        }
        
        .scrollable-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .scrollable-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .scrollable-content::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .scrollable-content::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        .no-data {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 20px;
        }
        
        /* Collapsible group styles */
        .property-group {
            margin: 8px 0;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background: white;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .group-header {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 12px 16px;
            cursor: pointer;
            font-weight: 600;
            color: #495057;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }
        
        .group-header:hover {
            background: linear-gradient(135deg, #e9ecef, #dee2e6);
        }
        
        .group-header.collapsed {
            border-bottom: none;
        }
        
        .group-icon {
            font-size: 12px;
            transition: transform 0.2s ease;
            color: #6c757d;
        }
        
        .group-header.collapsed .group-icon {
            transform: rotate(-90deg);
        }
        
        .group-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .group-content.collapsed {
            max-height: 0;
        }
        
        .table-wrapper {
            overflow-x: auto;
            overflow-y: hidden;
            width: 100%;
        }
        
        .table-wrapper::-webkit-scrollbar {
            height: 6px;
        }
        
        .table-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .table-wrapper::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        .group-table {
            width: 360px;
            border-collapse: collapse;
            background: white;
        }
        
        .group-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .group-table tr:hover {
            background-color: #e3f2fd;
        }
        
        .group-table td {
            padding: 8px 16px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
        }
        
        .group-table td:first-child {
            font-weight: 500;
            color: #495057;
            width: 40%;
        }
        
        .group-table td:last-child {
            color: #212529;
        }
        
        .group-table tr:last-child td {
            border-bottom: none;
        }
        
        /* Tooltip styles */
        .tooltip {
            position: relative;
            cursor: help;
        }
        
        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: fixed;
            bottom: auto;
            top: auto;
            left: auto;
            right: auto;
            transform: none;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            max-width: 300px;
            min-width: 100px;
            pointer-events: none;
            opacity: 0;
            animation: tooltipFade 0.2s ease-in-out forwards;
        }
        
        @keyframes tooltipFade {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .tooltip:hover::before {
            content: '';
            position: fixed;
            border: 6px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            pointer-events: none;
        }
        
        .truncated-text {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: inline-block;
        }
        
        .group-table td .truncated-text {
            max-width: 180px;
        }
        
        /* Geocoder search box customization */
        .mapboxgl-ctrl-geocoder {
            min-width: 300px;
            max-width: 400px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        @media (max-width: 768px) {
            .mapboxgl-ctrl-geocoder {
                min-width: 200px;
                max-width: 90vw;
            }
        }
        
        /* Custom Google Geocoder */
        .custom-geocoder {
            position: absolute;
            top: 60px;
            right: 10px;
            z-index: 2;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            width: 300px;
            display: none; /* Hidden by default, shown when in Hong Kong */
            transition: opacity 0.3s ease;
        }
        
        .custom-geocoder-input {
            width: 100%;
            padding: 10px 35px 10px 12px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
            outline: none;
        }
        
        .custom-geocoder-input:focus {
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.3);
        }
        
        .custom-geocoder-clear {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #999;
            font-size: 18px;
            padding: 4px 8px;
            display: none;
        }
        
        .custom-geocoder-clear:hover {
            color: #333;
        }
        
        .custom-geocoder-results {
            max-height: 400px;
            overflow-y: auto;
            border-top: 1px solid #eee;
            display: none;
        }
        
        .custom-geocoder-result {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f5f5f5;
            transition: background 0.15s;
        }
        
        .custom-geocoder-result:hover {
            background: #f5f5f5;
        }
        
        .custom-geocoder-result:last-child {
            border-bottom: none;
        }
        
        .custom-geocoder-result-title {
            font-size: 14px;
            color: #333;
            margin-bottom: 2px;
            font-weight: 500;
        }
        
        .custom-geocoder-result-subtitle {
            font-size: 12px;
            color: #666;
        }
        
        .custom-geocoder-loading {
            padding: 12px;
            text-align: center;
            color: #999;
            font-size: 13px;
            display: none;
        }
        
        .custom-geocoder-source {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 6px;
        }
        
        .source-google {
            background: #4285f4;
            color: white;
        }
        
        .source-mapbox {
            background: #3bb2d0;
            color: white;
        }
        
        @media (max-width: 768px) {
            .custom-geocoder {
                width: calc(100vw - 20px);
                right: 10px;
                left: 10px;
                top: auto;
                bottom: 10px;
                max-width: none;
            }
            
            .custom-geocoder.minimized {
                width: 0;
                height: 0;
                overflow: hidden;
                padding: 0;
                border: none;
                box-shadow: none;
            }
            
            .custom-geocoder.minimized .custom-geocoder-input {
                display: none;
            }
            
            .custom-geocoder.minimized .custom-geocoder-results,
            .custom-geocoder.minimized .custom-geocoder-loading,
            .custom-geocoder.minimized .custom-geocoder-clear {
                display: none !important;
            }
            
            /* Mapbox geocoder on mobile */
            .mapboxgl-ctrl-geocoder {
                width: calc(100vw - 80px) !important;
                max-width: calc(100vw - 80px) !important;
                min-width: auto !important;
                font-size: 14px !important;
            }
            
            .mapboxgl-ctrl-geocoder.minimized {
                width: 0 !important;
                min-width: 0 !important;
                height: 0 !important;
                padding: 0 !important;
                border: none !important;
                box-shadow: none !important;
                overflow: hidden !important;
            }
            
            .mapboxgl-ctrl-geocoder.minimized input {
                display: none;
            }
            
            .mapboxgl-ctrl-geocoder.minimized .mapboxgl-ctrl-geocoder--icon {
                display: none !important;
            }
            
            .mapboxgl-ctrl-geocoder.minimized .mapboxgl-ctrl-geocoder--button {
                display: none !important;
            }
            
            .layer-control {
                max-width: calc(100vw - 80px);
            }
        }
        
        /* Mobile toggle buttons for search boxes */
        .search-toggle-btn {
            display: none;
            position: absolute;
            width: 44px;
            height: 44px;
            background: white;
            border: none;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            font-size: 20px;
            z-index: 3;
            align-items: center;
            justify-content: center;
        }
        
        @media (max-width: 768px) {
            .search-toggle-btn {
                display: flex;
            }
            
            #toggle-mapbox-search {
                top: 10px;
                right: 10px;
            }
            
            #toggle-google-search {
                bottom: 10px;
                right: 10px;
            }
            
            /* Move Mapbox navigation controls below toggle button on mobile */
            .mapboxgl-ctrl-top-right {
                top: 64px !important;
            }
        }
        
        /* Highlighted parcel style */
        .highlighted-parcel {
            fill: yellow !important;
            fill-opacity: 0.8 !important;
            stroke: #ff0000 !important;
            stroke-width: 3px !important;
        }
    </style>
</head>
<body>
<div id="map"></div>

<!-- Mobile toggle buttons -->
<button id="toggle-mapbox-search" class="search-toggle-btn" title="Toggle Mapbox Search">üîç</button>
<button id="toggle-google-search" class="search-toggle-btn" title="Toggle Google Search" style="display: none;">üìç</button>

<!-- Custom Google Geocoder -->
<div class="custom-geocoder">
    <input 
        type="text" 
        class="custom-geocoder-input" 
        id="custom-search-input"
        placeholder="üåè Google Search (Hong Kong, Global)" 
        autocomplete="off"
    />
    <button class="custom-geocoder-clear" id="custom-search-clear">√ó</button>
    <div class="custom-geocoder-loading" id="custom-search-loading">Searching...</div>
    <div class="custom-geocoder-results" id="custom-search-results"></div>
</div>

<div class="layer-control collapsed">
    <h3 onclick="toggleLayerControl()">
        <span>Map Controls</span>
        <button class="toggle-btn" id="toggle-control-btn" onclick="event.stopPropagation(); toggleLayerControl();" aria-label="Toggle control panel">‚ñº</button>
    </h3>
    <div class="layer-content">
        <!-- Map Style Section -->
        <div class="control-section">
            <div class="section-label">Map Style</div>
            <select id="style-select-main" class="style-select">
                <option value="mapbox://styles/mapbox/streets-v11">Streets</option>
                <option value="mapbox://styles/mapbox/satellite-streets-v12">Satellite</option>
                <option value="mapbox://styles/mapbox/light-v11">Light</option>
                <option value="mapbox://styles/mapbox/dark-v11">Dark</option>
                <option value="mapbox://styles/mapbox/outdoors-v12">Outdoors</option>
            </select>
        </div>
        
        <hr style="margin: 12px 0; border: none; border-top: 1px solid #eee;">
        
        <!-- Layers Section -->
        <div class="control-section">
            <div class="section-label">Layers</div>
            <div class="layer-toggle">
                <input type="checkbox" id="philly-toggle" checked>
                <label for="philly-toggle">Philadelphia Parcels</label>
            </div>
            <div class="layer-toggle">
                <input type="checkbox" id="hk-parcels-toggle">
                <label for="hk-parcels-toggle">Hong Kong Parcels</label>
            </div>
            <div class="layer-toggle">
                <input type="checkbox" id="hk-buildings-toggle">
                <label for="hk-buildings-toggle">Hong Kong Buildings</label>
            </div>
            <div class="layer-toggle">
                <input type="checkbox" id="bc-parcels-toggle">
                <label for="bc-parcels-toggle">BC Canada Parcels</label>
            </div>
            <div class="layer-toggle">
                <input type="checkbox" id="seattle-parcels-toggle">
                <label for="seattle-parcels-toggle">Seattle Parcels</label>
            </div>
            <div class="layer-toggle">
                <input type="checkbox" id="toronto-parcels-toggle">
                <label for="toronto-parcels-toggle">Toronto Parcels</label>
            </div>
        </div>
        
        <hr style="margin: 12px 0; border: none; border-top: 1px solid #eee;">
        
        <!-- Navigation Section -->
        <div class="control-section">
            <div class="section-label">Quick Navigation</div>
            <button id="goto-philly" style="width: 100%; padding: 8px; margin: 4px 0; cursor: pointer; background: #3498db; color: white; border: none; border-radius: 4px; font-size: 13px;">Go to Philadelphia</button>
            <button id="goto-hk" style="width: 100%; padding: 8px; margin: 4px 0; cursor: pointer; background: #ff6600; color: white; border: none; border-radius: 4px; font-size: 13px;">Go to Hong Kong</button>
            <button id="goto-bc" style="width: 100%; padding: 8px; margin: 4px 0; cursor: pointer; background: #c41e3a; color: white; border: none; border-radius: 4px; font-size: 13px;">Go to BC Canada</button>
            <button id="goto-seattle" style="width: 100%; padding: 8px; margin: 4px 0; cursor: pointer; background: #0c5da5; color: white; border: none; border-radius: 4px; font-size: 13px;">Go to Seattle</button>
            <button id="goto-toronto" style="width: 100%; padding: 8px; margin: 4px 0; cursor: pointer; background: #d4001d; color: white; border: none; border-radius: 4px; font-size: 13px;">Go to Toronto</button>
            <button id="goto-home" style="width: 100%; padding: 8px; margin: 4px 0; cursor: pointer; background: #34495e; color: white; border: none; border-radius: 4px; font-size: 13px;">üè† Go to Home</button>
        </div>
    </div>
</div>
<script>
    // Performance optimization: viewport-based lazy loading
    const REGION_BOUNDS = {
        seattle: { west: -122.5, south: 47.0, east: -121.5, north: 47.9 },
        hongkong: { west: 113.8, south: 22.1, east: 114.5, north: 22.6 },
        philadelphia: { west: -75.3, south: 39.85, east: -74.95, north: 40.15 },
        bc: { west: -139.0, south: 48.0, east: -114.0, north: 60.0 }
    };

    // Check if viewport intersects with region
    function isRegionInView(regionBounds) {
        const bounds = map.getBounds();
        return !(bounds.getEast() < regionBounds.west ||
                bounds.getWest() > regionBounds.east ||
                bounds.getNorth() < regionBounds.south ||
                bounds.getSouth() > regionBounds.north);
    }

    // Smart layer loading based on viewport
    function optimizeLayerLoading() {
        const zoom = map.getZoom();
        
        // Only load Seattle tiles if viewport is near Seattle and zoomed in enough
        if (map.getLayer('seattle-parcels-fill')) {
            const shouldLoadSeattle = isRegionInView(REGION_BOUNDS.seattle) && zoom >= 9;
            // Tiles are loaded automatically, but we can set a flag for future optimizations
        }
        
        // Enable browser caching for tiles
        if (!map.hasImage('preload-indicator')) {
            // Prefetch tiles one zoom level ahead for smoother experience
            const currentZoom = Math.floor(zoom);
            if (currentZoom < 15) {
                // Mapbox GL JS handles prefetching internally
            }
        }
    }

    // Toggle layer control function
    function toggleLayerControl() {
        console.log('toggleLayerControl called'); // Debug
        const control = document.querySelector('.layer-control');
        const btn = document.querySelector('.toggle-btn');
        control.classList.toggle('collapsed');
        btn.textContent = control.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
        console.log('Collapsed:', control.classList.contains('collapsed')); // Debug
    }

    // Auto-collapse control panel on mobile devices
    function initMobileControls() {
        if (window.innerWidth <= 768) {
            const control = document.querySelector('.layer-control');
            const btn = document.querySelector('.toggle-btn');
            control.classList.add('collapsed');
            btn.textContent = '‚ñ∂';
        } else {
            // Show arrow on desktop too
            const btn = document.querySelector('.toggle-btn');
            btn.textContent = '‚ñº';
        }
    }

    // Initialize mobile controls on page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initMobileControls);
    } else {
        initMobileControls();
    }

    // Token will be injected during build or loaded from .env for local development
    mapboxgl.accessToken = '{{MAPBOX_ACCESS_TOKEN}}';
    
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [-20, 35], // World view to see all city markers
        zoom: 2,
        pitch: 0, // Initial pitch (0-85 degrees)
        bearing: 0, // Initial bearing (0-360 degrees)
        antialias: true, // For smoother 3D rendering
        // Performance optimizations
        maxTileCacheSize: 500, // Increase tile cache for better performance
        refreshExpiredTiles: false, // Don't auto-refresh old tiles
        fadeDuration: 100, // Faster fade for snappier feel
        collectResourceTiming: false // Disable resource timing for better performance
    });
    
    // Add viewport optimization on move end
    map.on('moveend', optimizeLayerLoading);
    map.on('zoomend', optimizeLayerLoading);
    
    // Google Maps API Key for enhanced geocoding (especially for Hong Kong)
    const GOOGLE_MAPS_API_KEY = '{{GOOGLE_MAPS_API_KEY}}';
    
    // Add geocoder (address search)
    const geocoder = new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        mapboxgl: mapboxgl,
        marker: false,
        placeholder: 'Search address (Hong Kong, US, Canada)',
        proximity: {
            longitude: -75.163471,
            latitude: 39.952583
        },
        countries: 'us,ca,cn',
        language: 'en',
        types: 'address,place,locality,neighborhood,poi,region',
        limit: 10
    });
    
    map.addControl(geocoder, 'top-right');
    
    // Custom Google Geocoder Implementation
    const customGeocoderDiv = document.querySelector('.custom-geocoder');
    const customSearchInput = document.getElementById('custom-search-input');
    const customSearchResults = document.getElementById('custom-search-results');
    const customSearchLoading = document.getElementById('custom-search-loading');
    const customSearchClear = document.getElementById('custom-search-clear');
    
    let searchTimeout;
    
    // Hong Kong bounds for showing Google geocoder
    const hongKongBounds = {
        west: 113.8,
        east: 114.5,
        south: 22.1,
        north: 22.6
    };
    
    // Function to check if map is viewing Hong Kong region
    function isViewingHongKong() {
        const center = map.getCenter();
        return center.lng >= hongKongBounds.west && 
               center.lng <= hongKongBounds.east && 
               center.lat >= hongKongBounds.south && 
               center.lat <= hongKongBounds.north;
    }
    
    // Show/hide Google geocoder based on location
    function updateGoogleGeocoderVisibility() {
        const toggleBtn = document.getElementById('toggle-google-search');
        
        if (isViewingHongKong()) {
            customGeocoderDiv.style.display = 'block';
            toggleBtn.style.display = 'flex';
        } else {
            customGeocoderDiv.style.display = 'none';
            toggleBtn.style.display = 'none';
            // Clear search when leaving Hong Kong
            if (customSearchInput.value) {
                customSearchInput.value = '';
                customSearchResults.style.display = 'none';
                customSearchClear.style.display = 'none';
            }
        }
    }
    
    // Update visibility on map move
    map.on('moveend', updateGoogleGeocoderVisibility);
    
    // Initial check
    updateGoogleGeocoderVisibility();
    
    // Mobile search toggle functionality
    const toggleMapboxBtn = document.getElementById('toggle-mapbox-search');
    const toggleGoogleBtn = document.getElementById('toggle-google-search');
    let mapboxSearchMinimized = false;
    let googleSearchMinimized = false;
    
    toggleMapboxBtn.addEventListener('click', () => {
        const geocoderControl = document.querySelector('.mapboxgl-ctrl-geocoder');
        if (geocoderControl) {
            mapboxSearchMinimized = !mapboxSearchMinimized;
            geocoderControl.classList.toggle('minimized', mapboxSearchMinimized);
            toggleMapboxBtn.textContent = mapboxSearchMinimized ? 'üîç' : '‚úï';
        }
    });
    
    toggleGoogleBtn.addEventListener('click', () => {
        googleSearchMinimized = !googleSearchMinimized;
        customGeocoderDiv.classList.toggle('minimized', googleSearchMinimized);
        toggleGoogleBtn.textContent = googleSearchMinimized ? 'üìç' : '‚úï';
    });
    
    // Show/hide clear button
    customSearchInput.addEventListener('input', function() {
        customSearchClear.style.display = this.value ? 'block' : 'none';
    });
    
    // Clear button click
    customSearchClear.addEventListener('click', function() {
        customSearchInput.value = '';
        customSearchResults.style.display = 'none';
        customSearchResults.innerHTML = '';
        customSearchClear.style.display = 'none';
        if (searchResultMarker) {
            searchResultMarker.remove();
            searchResultMarker = null;
        }
    });
    
    // Search on input
    customSearchInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();
        
        // Clear previous timeout
        clearTimeout(searchTimeout);
        
        if (query.length < 3) {
            customSearchResults.style.display = 'none';
            customSearchResults.innerHTML = '';
            customSearchLoading.style.display = 'none';
            return;
        }
        
        // Show loading
        customSearchLoading.style.display = 'block';
        customSearchResults.style.display = 'none';
        
        // Debounce search
        searchTimeout = setTimeout(() => {
            performGoogleSearch(query);
        }, 500);
    });
    
    async function performGoogleSearch(query) {
        try {
            // Debug logging
            console.log('Google API Key check:', {
                exists: !!GOOGLE_MAPS_API_KEY,
                isEmpty: GOOGLE_MAPS_API_KEY === '',
                isPlaceholder: GOOGLE_MAPS_API_KEY === '{{GOOGLE_MAPS_API_KEY}}',
                length: GOOGLE_MAPS_API_KEY ? GOOGLE_MAPS_API_KEY.length : 0,
                firstChars: GOOGLE_MAPS_API_KEY ? GOOGLE_MAPS_API_KEY.substring(0, 10) : 'none'
            });
            
            // Check if Google API key is configured (starts with AIza means it's a real Google key)
            if (!GOOGLE_MAPS_API_KEY || GOOGLE_MAPS_API_KEY === '' || !GOOGLE_MAPS_API_KEY.startsWith('AIza')) {
                customSearchLoading.style.display = 'none';
                customSearchResults.innerHTML = '<div style="padding: 12px; color: #999; font-size: 13px;">Google API key not configured. Please add GOOGLE_MAPS_API_KEY to your .env file.</div>';
                customSearchResults.style.display = 'block';
                return;
            }
            
            // Call Google Geocoding API
            const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(query)}&key=${GOOGLE_MAPS_API_KEY}`;
            const response = await fetch(url);
            const data = await response.json();
            
            customSearchLoading.style.display = 'none';
            
            if (data.status === 'OK' && data.results && data.results.length > 0) {
                displaySearchResults(data.results);
            } else if (data.status === 'ZERO_RESULTS') {
                customSearchResults.innerHTML = '<div style="padding: 12px; color: #999; font-size: 13px;">No results found</div>';
                customSearchResults.style.display = 'block';
            } else {
                customSearchResults.innerHTML = `<div style="padding: 12px; color: #999; font-size: 13px;">Error: ${data.status}</div>`;
                customSearchResults.style.display = 'block';
            }
        } catch (error) {
            console.error('Google Geocoding error:', error);
            customSearchLoading.style.display = 'none';
            customSearchResults.innerHTML = '<div style="padding: 12px; color: #999; font-size: 13px;">Search failed. Please try again.</div>';
            customSearchResults.style.display = 'block';
        }
    }
    
    function displaySearchResults(results) {
        customSearchResults.innerHTML = '';
        
        results.slice(0, 8).forEach((result, index) => {
            const resultDiv = document.createElement('div');
            resultDiv.className = 'custom-geocoder-result';
            
            const title = document.createElement('div');
            title.className = 'custom-geocoder-result-title';
            title.textContent = result.formatted_address;
            
            const subtitle = document.createElement('div');
            subtitle.className = 'custom-geocoder-result-subtitle';
            const types = result.types.slice(0, 2).join(', ');
            subtitle.innerHTML = `${types} <span class="custom-geocoder-source source-google">Google</span>`;
            
            resultDiv.appendChild(title);
            resultDiv.appendChild(subtitle);
            
            resultDiv.addEventListener('click', () => {
                selectSearchResult(result);
            });
            
            customSearchResults.appendChild(resultDiv);
        });
        
        customSearchResults.style.display = 'block';
    }
    
    function selectSearchResult(result) {
        // Parse coordinates - Google API can return lng/lat as properties or direct values
        const location = result.geometry.location;
        const lng = typeof location.lng === 'function' ? location.lng() : location.lng;
        const lat = typeof location.lat === 'function' ? location.lat() : location.lat;
        
        console.log('Selected location:', { lng, lat, result });
        
        // Validate coordinates
        if (isNaN(lng) || isNaN(lat) || lng === undefined || lat === undefined) {
            console.error('Invalid coordinates:', { lng, lat, location });
            customSearchResults.innerHTML = '<div style="padding: 12px; color: #f44; font-size: 13px;">Invalid coordinates received from Google</div>';
            customSearchResults.style.display = 'block';
            return;
        }
        
        // Hide results
        customSearchResults.style.display = 'none';
        
        // Update input
        customSearchInput.value = result.formatted_address;
        
        // Remove previous marker
        if (searchResultMarker) {
            searchResultMarker.remove();
        }
        
        // Add blue marker (shared with Mapbox geocoder)
        searchResultMarker = new mapboxgl.Marker({ color: '#4285f4' })
            .setLngLat([lng, lat])
            .addTo(map);
        
        // Fly to location
        map.flyTo({
            center: [lng, lat],
            zoom: 16,
            duration: 2000
        });
    }
    
    // Close results when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.custom-geocoder')) {
            customSearchResults.style.display = 'none';
        }
    });
    
    // Shared search result marker for both geocoders
    let searchResultMarker = null;
    
    // Handle Mapbox geocoder result
    geocoder.on('result', function(e) {
        const coords = e.result.geometry.coordinates;
        const lng = coords[0];
        const lat = coords[1];
        
        // Remove previous marker
        if (searchResultMarker) {
            searchResultMarker.remove();
        }
        
        // Add blue marker
        searchResultMarker = new mapboxgl.Marker({ color: '#4285f4' })
            .setLngLat([lng, lat])
            .addTo(map);
        
        // Fly to location
        map.flyTo({
            center: [lng, lat],
            zoom: 16,
            essential: true
        });
    });
        // Add navigation controls (zoom, rotation, pitch, compass)
    map.addControl(new mapboxgl.NavigationControl({
        visualizePitch: true,
        showCompass: true,
        showZoom: true
    }), 'top-right');

    // Add fullscreen control
    map.addControl(new mapboxgl.FullscreenControl(), 'top-right');

    // Add geolocate control
    map.addControl(new mapboxgl.GeolocateControl({
        positionOptions: {
            enableHighAccuracy: true
        },
        trackUserLocation: true,
        showUserHeading: true
    }), 'top-right');

    // Create custom 3D/2D toggle control
    class Toggle3DControl {
        onAdd(map) {
            this._map = map;
            this._container = document.createElement('div');
            this._container.className = 'mapboxgl-ctrl mapboxgl-ctrl-group';
            this._container.innerHTML = `
                <button type="button" title="Toggle 3D/2D view" id="toggle-3d-btn">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path d="M12 3L2 9l10 6 10-6-10-6zm0 14.5l-9-5.4V17l9 5.4 9-5.4v-4.9l-9 5.4z"/>
                    </svg>
                    <span style="font-size: 10px; display: block;">3D</span>
                </button>
            `;
            this._container.onclick = () => this.toggle3D();
            return this._container;
        }

        toggle3D() {
            const currentPitch = this._map.getPitch();
            const button = document.getElementById('toggle-3d-btn');
            if (currentPitch === 0) {
                this._map.easeTo({ pitch: 60, duration: 1000 });
                button.querySelector('span').textContent = '2D';
            } else {
                this._map.easeTo({ pitch: 0, bearing: 0, duration: 1000 });
                button.querySelector('span').textContent = '3D';
            }
        }

        onRemove() {
            this._container.parentNode.removeChild(this._container);
            this._map = undefined;
        }
    }
    map.addControl(new Toggle3DControl(), 'top-right');

    // Handle style switching from main control panel
    document.getElementById('style-select-main').onchange = (e) => {
        const style = e.target.value;
        
        // Save current visibility state of all layers
        const layerVisibility = {};
        ['hk-parcels-fill', 'hk-parcels-outline', 'hk-buildings-fill', 'hk-buildings-outline', 'philly-parcels-wms-layer', 'bc-parcels-fill', 'bc-parcels-outline', 'seattle-parcels-fill', 'seattle-parcels-outline', 'toronto-parcels-fill', 'toronto-parcels-outline'].forEach(layerId => {
            const layer = map.getLayer(layerId);
            if (layer) {
                layerVisibility[layerId] = map.getLayoutProperty(layerId, 'visibility') || 'visible';
            }
        });
        
        map.setStyle(style);
        // Re-add custom layers after style loads
        map.once('style.load', () => {
            readdCustomLayers();
            
            // Restore visibility state
            Object.keys(layerVisibility).forEach(layerId => {
                if (map.getLayer(layerId)) {
                    map.setLayoutProperty(layerId, 'visibility', layerVisibility[layerId]);
                }
            });
        });
    };

    // Function to re-add custom layers after style change
    function readdCustomLayers() {
        // Re-add terrain
        if (!map.getSource('mapbox-dem')) {
            map.addSource('mapbox-dem', {
                'type': 'raster-dem',
                'url': 'mapbox://mapbox.mapbox-terrain-dem-v1',
                'tileSize': 512,
                'maxzoom': 14
            });
        }
        map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });

        // Re-add 3D buildings
        const layers = map.getStyle().layers;
        const labelLayerId = layers.find(
            (layer) => layer.type === 'symbol' && layer.layout && layer.layout['text-field']
        )?.id;

        if (labelLayerId && !map.getLayer('3d-buildings')) {
            map.addLayer(
                {
                    'id': '3d-buildings',
                    'source': 'composite',
                    'source-layer': 'building',
                    'filter': ['==', 'extrude', 'true'],
                    'type': 'fill-extrusion',
                    'minzoom': 15,
                    'paint': {
                        'fill-extrusion-color': '#aaa',
                        'fill-extrusion-height': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            15,
                            0,
                            15.05,
                            ['get', 'height']
                        ],
                        'fill-extrusion-base': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            15,
                            0,
                            15.05,
                            ['get', 'min_height']
                        ],
                        'fill-extrusion-opacity': 0.6
                    }
                },
                labelLayerId
            );
        }

        // Re-add Philadelphia Parcels WMS
        if (!map.getSource('philly-parcels-wms')) {
            map.addSource('philly-parcels-wms', {
                'type': 'raster',
                'tiles': [
                    'https://mapservices.pasda.psu.edu/server/services/pasda/CityPhilly/MapServer/WMSServer?' +
                    'SERVICE=WMS&REQUEST=GetMap&VERSION=1.1.1&LAYERS=16&STYLES=&FORMAT=image/png' +
                    '&SRS=EPSG:3857&BBOX={bbox-epsg-3857}&WIDTH=256&HEIGHT=256&TRANSPARENT=true'
                ],
                'tileSize': 256,
                'attribution': 'Philadelphia Parcels WMS',
                'queryable': true
            });
        }

        if (!map.getLayer('philly-parcels-wms-layer')) {
            map.addLayer({
                'id': 'philly-parcels-wms-layer',
                'type': 'raster',
                'source': 'philly-parcels-wms',
                'paint': {
                    'raster-opacity': 0.6
                },
                'minzoom': 13
            });
        }

        // Re-add Hong Kong Land Parcels
        if (!map.getSource('hk-parcels-geojson')) {
            map.addSource('hk-parcels-geojson', {
                type: 'vector',
                tiles: ['https://terratone-tiles-mfayf.ondigitalocean.app/LandParcel_Lot_HK/{z}/{x}/{y}.pbf'],
                minzoom: 13,
                maxzoom: 16,
                buffer: 0,
                tolerance: 0.375
            });
        }

        if (!map.getLayer('hk-parcels-fill')) {
            map.addLayer({
                'id': 'hk-parcels-fill',
                'type': 'fill',
                'source': 'hk-parcels-geojson',
                'source-layer': 'land_parcels',
                'minzoom': 13,
                'paint': {
                    'fill-color': 'transparent',
                    'fill-opacity': 0
                },
                'layout': {
                    'visibility': 'none'
                }
            });
        }

        if (!map.getLayer('hk-parcels-outline')) {
            map.addLayer({
                'id': 'hk-parcels-outline',
                'type': 'line',
                'source': 'hk-parcels-geojson',
                'source-layer': 'land_parcels',
                'minzoom': 14,
                'paint': {
                    'line-color': '#808080',
                    'line-width': 0.5
                },
                'layout': {
                    'visibility': 'none'
                }
            });
        }

        // Re-add Hong Kong Buildings
        if (!map.getSource('hk-buildings-geojson')) {
            map.addSource('hk-buildings-geojson', {
                type: 'vector',
                tiles: ['https://terratone-tiles-mfayf.ondigitalocean.app/Building_HK/{z}/{x}/{y}.pbf'],
                minzoom: 13,
                maxzoom: 16
            });
        }

        if (!map.getLayer('hk-buildings-fill')) {
            map.addLayer({
                'id': 'hk-buildings-fill',
                'type': 'fill',
                'source': 'hk-buildings-geojson',
                'source-layer': 'buildings',
                'paint': {
                    'fill-color': '#3498db',
                    'fill-opacity': 0.6
                },
                'layout': {
                    'visibility': 'none'
                }
            });
        }

        if (!map.getLayer('hk-buildings-outline')) {
            map.addLayer({
                'id': 'hk-buildings-outline',
                'type': 'line',
                'source': 'hk-buildings-geojson',
                'source-layer': 'buildings',
                'paint': {
                    'line-color': '#2c3e50',
                    'line-width': 1
                },
                'layout': {
                    'visibility': 'none'
                }
            });
        }
        
        // Re-add BC Canada Parcels PMTiles
        if (!map.getSource('bc-parcels-pmtiles')) {
            map.addSource('bc-parcels-pmtiles', {
                type: 'vector',
                tiles: ['https://terratone-tiles-mfayf.ondigitalocean.app/BC_Parcels/{z}/{x}/{y}.pbf'],
                minzoom: 10,
                maxzoom: 16,
                bounds: [-139.06, 48.30, -114.03, 60.00]
            });
        }

        if (!map.getLayer('bc-parcels-fill')) {
            map.addLayer({
                'id': 'bc-parcels-fill',
                'type': 'fill',
                'source': 'bc-parcels-pmtiles',
                'source-layer': 'bc_parcels',
                'minzoom': 10,
                'paint': {
                    'fill-color': 'transparent',
                    'fill-opacity': 0
                },
                'layout': {
                    'visibility': 'none'
                }
            });
        }

        if (!map.getLayer('bc-parcels-outline')) {
            map.addLayer({
                'id': 'bc-parcels-outline',
                'type': 'line',
                'source': 'bc-parcels-pmtiles',
                'source-layer': 'bc_parcels',
                'minzoom': 10,
                'paint': {
                    'line-color': '#808080',
                    'line-width': 0.5
                },
                'layout': {
                    'visibility': 'none'
                }
            });
        }
        
        // Re-add Seattle Parcels PMTiles
        if (!map.getSource('seattle-parcels-pmtiles')) {
            map.addSource('seattle-parcels-pmtiles', {
                type: 'vector',
                tiles: ['https://terratone-tiles-mfayf.ondigitalocean.app/Seattle_Parcels/{z}/{x}/{y}.pbf?v=1'],
                minzoom: 10,
                maxzoom: 16
            });
        }

        if (!map.getLayer('seattle-parcels-fill')) {
            map.addLayer({
                'id': 'seattle-parcels-fill',
                'type': 'fill',
                'source': 'seattle-parcels-pmtiles',
                'source-layer': 'seattle_parcels',
                'paint': {
                    'fill-color': '#0c5da5',
                    'fill-opacity': 0.5
                },
                'layout': {
                    'visibility': 'none'
                }
            });
        }

        if (!map.getLayer('seattle-parcels-outline')) {
            map.addLayer({
                'id': 'seattle-parcels-outline',
                'type': 'line',
                'source': 'seattle-parcels-pmtiles',
                'source-layer': 'seattle_parcels',
                'paint': {
                    'line-color': '#003d7a',
                    'line-width': 1
                },
                'layout': {
                    'visibility': 'none'
                }
            });
        }
        
        // Re-add Toronto Parcels PMTiles
        if (!map.getSource('toronto-parcels-pmtiles')) {
            map.addSource('toronto-parcels-pmtiles', {
                type: 'vector',
                tiles: ['https://terratone-tiles-mfayf.ondigitalocean.app/Toronto_Parcels/{z}/{x}/{y}.pbf'],
                minzoom: 10,
                maxzoom: 16
            });
        }

        if (!map.getLayer('toronto-parcels-fill')) {
            map.addLayer({
                'id': 'toronto-parcels-fill',
                'type': 'fill',
                'source': 'toronto-parcels-pmtiles',
                'source-layer': 'toronto_parcels',
                'paint': {
                    'fill-color': '#d4001d',
                    'fill-opacity': 0.5
                },
                'layout': {
                    'visibility': 'none'
                }
            });
        }

        if (!map.getLayer('toronto-parcels-outline')) {
            map.addLayer({
                'id': 'toronto-parcels-outline',
                'type': 'line',
                'source': 'toronto-parcels-pmtiles',
                'source-layer': 'toronto_parcels',
                'paint': {
                    'line-color': '#8b0000',
                    'line-width': 1
                },
                'layout': {
                    'visibility': 'none'
                }
            });
        }
    }

    // Enable 3D terrain and buildings when map loads
    map.on('load', () => {
        // Add 3D terrain
        if (!map.getSource('mapbox-dem')) {
            map.addSource('mapbox-dem', {
                'type': 'raster-dem',
                'url': 'mapbox://mapbox.mapbox-terrain-dem-v1',
                'tileSize': 512,
                'maxzoom': 14
            });
        }
        map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });

        // Add 3D buildings layer
        const layers = map.getStyle().layers;
        const labelLayerId = layers.find(
            (layer) => layer.type === 'symbol' && layer.layout && layer.layout['text-field']
        )?.id;

        if (labelLayerId) {
            map.addLayer(
                {
                    'id': '3d-buildings',
                    'source': 'composite',
                    'source-layer': 'building',
                    'filter': ['==', 'extrude', 'true'],
                    'type': 'fill-extrusion',
                    'minzoom': 15,
                    'paint': {
                        'fill-extrusion-color': '#aaa',
                        'fill-extrusion-height': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            15,
                            0,
                            15.05,
                            ['get', 'height']
                        ],
                        'fill-extrusion-base': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            15,
                            0,
                            15.05,
                            ['get', 'min_height']
                        ],
                        'fill-extrusion-opacity': 0.6
                    }
                },
                labelLayerId
            );
        }

        // Philadelphia Parcels WMS
        map.addSource('philly-parcels-wms', {
            'type': 'raster',
            'tiles': [
                'https://mapservices.pasda.psu.edu/server/services/pasda/CityPhilly/MapServer/WMSServer?' +
                'SERVICE=WMS&REQUEST=GetMap&VERSION=1.1.1&LAYERS=16&STYLES=&FORMAT=image/png' +
                '&SRS=EPSG:3857&BBOX={bbox-epsg-3857}&WIDTH=256&HEIGHT=256&TRANSPARENT=true'
            ],
            'tileSize': 256,
            'attribution': 'Philadelphia Parcels WMS',
            'queryable': true
        });

        map.addLayer({
            'id': 'philly-parcels-wms-layer',
            'type': 'raster',
            'source': 'philly-parcels-wms',
            'paint': {
                'raster-opacity': 0.6
            },
            'minzoom': MAP_CONFIG.MIN_ZOOM_FOR_PARCELS
        });

        // Hong Kong Land Parcels - Vector Tiles from PMTiles server
        map.addSource('hk-parcels-geojson', {
            type: 'vector',
            tiles: ['https://terratone-tiles-mfayf.ondigitalocean.app/LandParcel_Lot_HK/{z}/{x}/{y}.pbf'],
            minzoom: 13,
            maxzoom: 16,
            bounds: [113.8, 22.1, 114.5, 22.6], // Hong Kong bounds
            buffer: 0,
            tolerance: 0.375
        });

        map.addLayer({
            'id': 'hk-parcels-fill',
            'type': 'fill',
            'source': 'hk-parcels-geojson',
            'source-layer': 'land_parcels',
            'paint': {
                'fill-color': 'transparent',
                'fill-opacity': 0
            },
            'layout': {
                'visibility': 'none'
            },
            'minzoom': 10
        });

        map.addLayer({
            'id': 'hk-parcels-outline',
            'type': 'line',
            'source': 'hk-parcels-geojson',
            'source-layer': 'land_parcels',
            'paint': {
                'line-color': '#808080',
                'line-width': 0.5
            },
            'layout': {
                'visibility': 'none'
            }
        });

        // Hong Kong Buildings - Vector Tiles from PMTiles server
        map.addSource('hk-buildings-geojson', {
            type: 'vector',
            tiles: ['https://terratone-tiles-mfayf.ondigitalocean.app/Building_HK/{z}/{x}/{y}.pbf'],
            minzoom: 13,
            maxzoom: 16
        });

        map.addLayer({
            'id': 'hk-buildings-fill',
            'type': 'fill',
            'source': 'hk-buildings-geojson',
            'source-layer': 'buildings',
            'paint': {
                'fill-color': '#3498db',
                'fill-opacity': 0.6
            },
            'layout': {
                'visibility': 'none'
            }
        });

        map.addLayer({
            'id': 'hk-buildings-outline',
            'type': 'line',
            'source': 'hk-buildings-geojson',
            'source-layer': 'buildings',
            'paint': {
                'line-color': '#2c3e50',
                'line-width': 1
            },
            'layout': {
                'visibility': 'none'
            }
        });

        // BC Canada Parcels PMTiles
        map.addSource('bc-parcels-pmtiles', {
            type: 'vector',
            tiles: ['https://terratone-tiles-mfayf.ondigitalocean.app/BC_Parcels/{z}/{x}/{y}.pbf'],
            minzoom: 10,
            maxzoom: 16,
            bounds: [-139.06, 48.30, -114.03, 60.00], // BC province bounds
            scheme: 'xyz'
        });

        map.addLayer({
            'id': 'bc-parcels-fill',
            'type': 'fill',
            'source': 'bc-parcels-pmtiles',
            'source-layer': 'bc_parcels',
            'paint': {
                'fill-color': 'transparent',
                'fill-opacity': 0
            },
            'layout': {
                'visibility': 'none'
            },
            'minzoom': 10
        });

        map.addLayer({
            'id': 'bc-parcels-outline',
            'type': 'line',
            'source': 'bc-parcels-pmtiles',
            'source-layer': 'bc_parcels',
            'paint': {
                'line-color': '#808080',
                'line-width': 0.5
            },
            'layout': {
                'visibility': 'none'
            }
        });
        
        // Seattle Parcels PMTiles with optimizations
        map.addSource('seattle-parcels-pmtiles', {
            type: 'vector',
            tiles: ['https://terratone-tiles-mfayf.ondigitalocean.app/Seattle_Parcels/{z}/{x}/{y}.pbf?v=1'],
            minzoom: 10,
            maxzoom: 16,
            bounds: [-122.5, 47.0, -121.5, 47.9], // Seattle/King County bounds for viewport culling
            scheme: 'xyz',
            promoteId: {'seattle_parcels': 'OBJECTID'} // Enable feature state for better performance
        });

        map.addLayer({
            'id': 'seattle-parcels-fill',
            'type': 'fill',
            'source': 'seattle-parcels-pmtiles',
            'source-layer': 'seattle_parcels',
            'paint': {
                'fill-color': 'transparent',
                'fill-opacity': 0
            },
            'layout': {
                'visibility': 'none'
            },
            'minzoom': 10
        });

        map.addLayer({
            'id': 'seattle-parcels-outline',
            'type': 'line',
            'source': 'seattle-parcels-pmtiles',
            'source-layer': 'seattle_parcels',
            'paint': {
                'line-color': '#808080',
                'line-width': 0.5
            },
            'layout': {
                'visibility': 'none'
            },
            'minzoom': 11  // Only show outlines at zoom 11+ for better performance
        });
        
        // Toronto Parcels PMTiles
        map.addSource('toronto-parcels-pmtiles', {
            type: 'vector',
            tiles: ['https://terratone-tiles-mfayf.ondigitalocean.app/Toronto_Parcels/{z}/{x}/{y}.pbf'],
            minzoom: 10,
            maxzoom: 16,
            bounds: [-79.64, 43.58, -79.12, 43.86], // Toronto bounds
            scheme: 'xyz'
        });

        map.addLayer({
            'id': 'toronto-parcels-fill',
            'type': 'fill',
            'source': 'toronto-parcels-pmtiles',
            'source-layer': 'toronto_parcels',
            'paint': {
                'fill-color': 'transparent',
                'fill-opacity': 0
            },
            'layout': {
                'visibility': 'none'
            },
            'minzoom': 10
        });

        map.addLayer({
            'id': 'toronto-parcels-outline',
            'type': 'line',
            'source': 'toronto-parcels-pmtiles',
            'source-layer': 'toronto_parcels',
            'paint': {
                'line-color': '#808080',
                'line-width': 0.5
            },
            'layout': {
                'visibility': 'none'
            },
            'minzoom': 11
        });
    });

    // Add city markers on the map
    const cities = [
        {
            name: 'Philadelphia',
            coordinates: [-75.163471, 39.952583],
            color: '#3498db',
            layer: 'philly-parcels-wms-layer'
        },
        {
            name: 'Hong Kong',
            coordinates: [114.1694, 22.3193],
            color: '#e74c3c',
            layer: 'hk-parcels-fill'
        },
        {
            name: 'Seattle',
            coordinates: [-122.3321, 47.6062],
            color: '#2ecc71',
            layer: 'seattle-parcels-fill'
        },
        {
            name: 'Toronto',
            coordinates: [-79.3832, 43.6532],
            color: '#f39c12',
            layer: 'toronto-parcels-fill'
        },
        {
            name: 'Vancouver (BC)',
            coordinates: [-123.1139, 49.2827],
            color: '#9b59b6',
            layer: 'bc-parcels-fill'
        }
    ];

    // Store markers globally for visibility control
    const cityMarkers = [];

    // Create markers for each city
    cities.forEach(city => {
        // Create a custom marker element
        const el = document.createElement('div');
        el.className = 'city-marker';
        el.style.backgroundColor = city.color;
        el.style.width = '30px';
        el.style.height = '30px';
        el.style.borderRadius = '50%';
        el.style.border = '3px solid white';
        el.style.boxShadow = '0 2px 6px rgba(0,0,0,0.3)';
        el.style.cursor = 'pointer';
        el.style.display = 'flex';
        el.style.alignItems = 'center';
        el.style.justifyContent = 'center';
        el.style.fontSize = '16px';
        el.style.fontWeight = 'bold';
        el.style.color = 'white';
        el.innerHTML = city.name.charAt(0);
        el.title = `Click to fly to ${city.name}`;

        // Add click event to fly to the city
        el.addEventListener('click', () => {
            map.flyTo({
                center: city.coordinates,
                zoom: city.name === 'Hong Kong' ? 12 : (city.name === 'Philadelphia' ? 11 : 13),
                essential: true
            });
            
            // Enable the layer when clicking the marker
            if (map.getLayer(city.layer)) {
                map.setLayoutProperty(city.layer, 'visibility', 'visible');
                
                // For PMTiles layers, also enable the outline layer
                const outlineLayer = city.layer.replace('-fill', '-outline');
                if (map.getLayer(outlineLayer)) {
                    map.setLayoutProperty(outlineLayer, 'visibility', 'visible');
                }
                
                // Update checkbox state
                const checkboxId = city.layer.replace(/-wms-layer|-fill/, '-toggle');
                const checkbox = document.getElementById(checkboxId);
                if (checkbox) checkbox.checked = true;
            }
        });

        // Create marker and add to map
        const marker = new mapboxgl.Marker(el)
            .setLngLat(city.coordinates)
            .addTo(map);
        
        cityMarkers.push(marker);
    });

    // Hide markers when zoomed in (zoom > 6), show when zoomed out
    map.on('zoom', () => {
        const currentZoom = map.getZoom();
        cityMarkers.forEach(marker => {
            const markerEl = marker.getElement();
            if (currentZoom > 6) {
                markerEl.style.display = 'none';
            } else {
                markerEl.style.display = 'flex';
            }
        });
    });

    // Property grouping configuration
    const propertyGroups = {
        'Basic Information': ['TENCODE', 'tencode', 'ADDRESS', 'address', 'OWNERNAME', 'ownername', 'PROPERTYTYPE', 'propertytype'],
        'Location Details': ['STREET', 'street', 'WARD', 'ward', 'BLOCK', 'block', 'LOT', 'lot', 'UNIT', 'unit'],
        'Assessment Info': ['ASSESSEDVALUE', 'assessedvalue', 'MARKETVALUE', 'marketvalue', 'TAXABLE', 'taxable', 'EXEMPT', 'exempt'],
        'Building Details': ['STORIES', 'stories', 'YEARBUILT', 'yearbuilt', 'SQFT', 'sqft', 'BEDROOMS', 'bedrooms', 'BATHROOMS', 'bathrooms'],
        'Zoning & Land Use': ['ZONING', 'zoning', 'LANDUSE', 'landuse', 'LOTSIZE', 'lotsize', 'FRONTAGE', 'frontage'],
        'Other Properties': [] // Fallback for any unmatched properties
    };

    // Function to group properties
    function groupProperties(feature) {
        const grouped = {};
        const usedProps = new Set();
        
        // Initialize all groups
        Object.keys(propertyGroups).forEach(groupName => {
            grouped[groupName] = {};
        });
        
        // Assign properties to groups
        Object.entries(feature).forEach(([key, value]) => {
            let assigned = false;
            
            for (const [groupName, keywords] of Object.entries(propertyGroups)) {
                if (groupName === 'Other Properties') continue;
                
                if (keywords.some(keyword => key.toLowerCase() === keyword.toLowerCase())) {
                    grouped[groupName][key] = value;
                    usedProps.add(key);
                    assigned = true;
                    break;
                }
            }
            
            // If not assigned to any specific group, add to "Other Properties"
            if (!assigned) {
                grouped['Other Properties'][key] = value;
            }
        });
        
        // Remove empty groups
        Object.keys(grouped).forEach(groupName => {
            if (Object.keys(grouped[groupName]).length === 0) {
                delete grouped[groupName];
            }
        });
        
        return grouped;
    }

    // Function to toggle group visibility
    window.toggleGroup = function(groupId) {
        const header = document.getElementById(groupId + '-header');
        const content = document.getElementById(groupId + '-content');
        const icon = document.getElementById(groupId + '-icon');
        
        if (content.classList.contains('collapsed')) {
            content.classList.remove('collapsed');
            header.classList.remove('collapsed');
            icon.innerHTML = '‚ñº';
        } else {
            content.classList.add('collapsed');
            header.classList.add('collapsed');
            icon.innerHTML = '‚ñ∂';
        }
    };
    
    // Function to toggle popup expand/collapse on mobile
    window.togglePopupExpand = function() {
        const container = document.getElementById('popup-main');
        const btn = document.getElementById('popup-expand-btn');
        
        if (!container || !btn) return;
        
        if (container.classList.contains('compact')) {
            container.classList.remove('compact');
            btn.innerHTML = '‚ñ≤ Show Less';
        } else {
            container.classList.add('compact');
            btn.innerHTML = '‚ñº Show More Details';
        }
    };

    // Function to create truncated text with tooltip
    function createTruncatedContent(text, maxLength = 10) {
        if (!text || text === null || text === undefined) return 'N/A';
        
        const textStr = String(text).trim();
        
        // For testing - if it's a short string, let's simulate a longer one occasionally
        // Remove this in production
        /*
        if (textStr.length < 15 && Math.random() < 0.3) {
            const longText = textStr + " - This is a very long additional description that should trigger the truncation and tooltip functionality to demonstrate how it works with lengthy property values";
            if (longText.length > maxLength) {
                const escapedText = longText
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#x27;');
                return `<span class="tooltip truncated-text" data-tooltip="${escapedText}" onmouseenter="showTooltip(event, '${escapedText}')" onmouseleave="hideTooltip()">${longText}</span>`;
            }
        }
        */
        if (textStr.length <= maxLength) {
            return textStr;
        }
        
        // Escape HTML characters for tooltip
        const escapedText = textStr
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#x27;');
            
        return `<span class="tooltip truncated-text" data-tooltip="${escapedText}" onmouseenter="showTooltip(event, '${escapedText}')" onmouseleave="hideTooltip()">${textStr}</span>`;
    }

    // JavaScript tooltip functions
    let currentTooltip = null;
    
    window.showTooltip = function(event, text) {
        hideTooltip(); // Remove any existing tooltip
        
        const tooltip = document.createElement('div');
        tooltip.className = 'js-tooltip';
        tooltip.textContent = text;
        tooltip.style.cssText = `
            position: fixed;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            max-width: 300px;
            min-width: 100px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        `;
        
        document.body.appendChild(tooltip);
        
        // Position tooltip
        const rect = event.target.getBoundingClientRect();
        const tooltipRect = tooltip.getBoundingClientRect();
        
        let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
        let top = rect.top - tooltipRect.height - 10;
        
        // Adjust if tooltip goes off screen - account for popup containers
        const margin = 15;
        const popupContainer = event.target.closest('.popup-container');
        const containerRect = popupContainer ? popupContainer.getBoundingClientRect() : { left: 0, right: window.innerWidth };
        
        if (left < containerRect.left + margin) left = containerRect.left + margin;
        if (left + tooltipRect.width > Math.min(containerRect.right, window.innerWidth) - margin) {
            left = Math.min(containerRect.right, window.innerWidth) - tooltipRect.width - margin;
        }
        if (top < margin) {
            top = rect.bottom + 10;
        }
        // Ensure tooltip doesn't go below viewport
        if (top + tooltipRect.height > window.innerHeight - margin) {
            top = rect.top - tooltipRect.height - 10;
        }
        
        tooltip.style.left = left + 'px';
        tooltip.style.top = top + 'px';
        
        // Fade in
        requestAnimationFrame(() => {
            tooltip.style.opacity = '1';
        });
        
        currentTooltip = tooltip;
    };
    
    window.hideTooltip = function() {
        if (currentTooltip) {
            currentTooltip.remove();
            currentTooltip = null;
        }
    };

    // Global function to show detailed feature information
    window.showFeatureDetails = function(featureIndex) {
        if (!window.currentFeatures || !Array.isArray(window.currentFeatures)) {
            console.error('No features data available');
            return;
        }
        
        if (featureIndex < 0 || featureIndex >= window.currentFeatures.length) {
            console.error('Feature index out of bounds:', featureIndex);
            return;
        }
        
        const feature = window.currentFeatures[featureIndex];
        const lngLat = window.currentLngLat;
        
        if (!feature || !lngLat) {
            console.error('Invalid feature or location data');
            return;
        }
        
        // Group properties into categories
        const groupedProps = groupProperties(feature);
        
        // Detect if mobile
        const isMobile = window.innerWidth <= 768;
        
        console.log('Mobile detection:', { isMobile, width: window.innerWidth });
        
        // Create detailed popup content with collapsible groups
        let popupContent = `<div class="popup-container ${isMobile ? 'compact' : ''}" id="popup-main">`;
        popupContent += '<div class="popup-title">Selected Parcel Details</div>';
        popupContent += '<div class="scrollable-content">';
        
        let groupIndex = 0;
        for (const [groupName, properties] of Object.entries(groupedProps)) {
            const groupId = `group-${groupIndex}`;
            const isFirst = groupIndex === 0;
            
            popupContent += `<div class="property-group">`;
            popupContent += `<div class="group-header ${!isFirst ? 'collapsed' : ''}" id="${groupId}-header" onclick="toggleGroup('${groupId}')">`;
            popupContent += `<span>${groupName} (${Object.keys(properties).length})</span>`;
            popupContent += `<span class="group-icon" id="${groupId}-icon">${isFirst ? '‚ñº' : '‚ñ∂'}</span>`;
            popupContent += `</div>`;
            popupContent += `<div class="group-content ${!isFirst ? 'collapsed' : ''}" id="${groupId}-content">`;
            popupContent += `<div class="table-wrapper">`;
            popupContent += `<table class="group-table">`;
            
            for (const [key, value] of Object.entries(properties)) {
                const truncatedValue = createTruncatedContent(value);
                popupContent += `<tr><td>${key}</td><td>${truncatedValue}</td></tr>`;
            }
            
            popupContent += `</table></div></div></div>`;
            groupIndex++;
        }
        
        popupContent += '</div>';
        
        // Add expand/collapse button for mobile
        if (isMobile) {
            popupContent += '<button onclick="togglePopupExpand()" class="popup-expand-btn" id="popup-expand-btn">‚ñº Show More Details</button>';
        }
        
        popupContent += '<button onclick="showFeatureSelection()" class="popup-button">‚Üê Back to Selection</button>';
        popupContent += '</div>';
        
        // Close current popup and show detailed one
        const popups = document.getElementsByClassName('mapboxgl-popup');
        for (let i = 0; i < popups.length; i++) {
            popups[i].remove();
        }
        
        new mapboxgl.Popup()
            .setLngLat(lngLat)
            .setHTML(popupContent)
            .addTo(map);
    };
    
    // Function to go back to feature selection
    window.showFeatureSelection = function() {
        const features = window.currentFeatures;
        const lngLat = window.currentLngLat;
        
        if (!features || !Array.isArray(features) || features.length === 0 || !lngLat) {
            console.error('Invalid features data or location');
            return;
        }
        
        const isMobile = window.innerWidth <= 768;
        
        // Recreate selection popup with professional styling
        let popupContent = `<div class="popup-container ${isMobile ? 'compact' : ''}" id="popup-main">`;
        popupContent += `<div class="popup-title">Multiple Parcels Found (${features.length})</div>`;
        popupContent += '<div class="scrollable-content">';
        
        features.forEach((feature, index) => {
            const tencode = feature.TENCODE || feature.tencode || feature.Tencode || 'N/A';
            const address = feature.ADDRESS || feature.address || feature.Address || 'No Address';
            
            popupContent += `<div class="selection-card" onclick="showFeatureDetails(${index})">`;
            popupContent += `<div class="selection-card-title">TENCODE: ${tencode}</div>`;
            popupContent += `<div class="selection-card-subtitle">Address: ${address}</div>`;
            popupContent += '<div class="selection-card-hint">Click to view full details</div>';
            popupContent += '</div>';
        });
        
        popupContent += '</div>';
        
        // Add expand button for mobile
        if (isMobile) {
            popupContent += '<button onclick="togglePopupExpand()" class="popup-expand-btn" id="popup-expand-btn">‚ñº Show All</button>';
        }
        
        popupContent += '</div>';
        
        // Close current popup and show selection one
        const popups = document.getElementsByClassName('mapboxgl-popup');
        for (let i = 0; i < popups.length; i++) {
            popups[i].remove();
        }
        
        new mapboxgl.Popup()
            .setLngLat(lngLat)
            .setHTML(popupContent)
            .addTo(map);
    };

    // Configuration constants
    const MAP_CONFIG = {
        MIN_ZOOM_FOR_PARCELS: 14,
        BBOX_PRECISION: 0.0000001 // ~0.33m at Philadelphia latitude
    };
    
    // Race condition protection
    let isClickProcessing = false;
    
    // Add click event for parcels
    map.on('click', (e) => {
            // Only show popups when parcels are visible (zoom level check)
            if (map.getZoom() >= MAP_CONFIG.MIN_ZOOM_FOR_PARCELS) {
                // Prevent race conditions from multiple rapid clicks
                if (isClickProcessing) return;
                isClickProcessing = true;
                
                const lng = e.lngLat.lng;
                const lat = e.lngLat.lat;
                
                console.log('Click details:', { lng, lat, zoom: map.getZoom() });
                
                // Define geographic bounds for each region
                const regionBounds = {
                    hongKong: {
                        west: 113.8,
                        east: 114.5,
                        south: 22.1,
                        north: 22.6
                    },
                    seattle: {
                        west: -122.5,
                        east: -121.5,
                        south: 47.0,
                        north: 47.9
                    },
                    toronto: {
                        west: -79.64,
                        east: -79.12,
                        south: 43.58,
                        north: 43.86
                    },
                    bc: {
                        west: -139.06,
                        east: -114.03,
                        south: 48.30,
                        north: 60.00
                    },
                    philadelphia: {
                        west: -75.28,
                        east: -74.96,
                        south: 39.87,
                        north: 40.14
                    }
                };
                
                // Helper function to check if point is in bounds
                const isInBounds = (bounds) => {
                    return lng >= bounds.west && lng <= bounds.east && 
                           lat >= bounds.south && lat <= bounds.north;
                };
                
                // Check if HK layers exist and are visible
                const hkParcelsLayer = map.getLayer('hk-parcels-fill');
                const hkBuildingsLayer = map.getLayer('hk-buildings-fill');
                
                const hkParcelsVisible = hkParcelsLayer && map.getLayoutProperty('hk-parcels-fill', 'visibility') !== 'none';
                const hkBuildingsVisible = hkBuildingsLayer && map.getLayoutProperty('hk-buildings-fill', 'visibility') !== 'none';
                
                // Only query HK layers if click is within HK bounds
                if ((hkParcelsVisible || hkBuildingsVisible) && isInBounds(regionBounds.hongKong)) {
                    const layers = [];
                    if (hkParcelsVisible) layers.push('hk-parcels-fill');
                    if (hkBuildingsVisible) layers.push('hk-buildings-fill');
                    
                    const features = map.queryRenderedFeatures(e.point, { layers });
                    
                    if (features.length > 0) {
                        const feature = features[0];
                        const layerType = feature.layer.id.includes('parcels') ? 'Land Parcel' : 'Building';
                        const isMobile = window.innerWidth <= 768;
                        
                        console.log('HK Mobile detection:', { isMobile, width: window.innerWidth });
                        
                        let popupContent = `<div class="popup-container ${isMobile ? 'compact' : ''}" id="popup-main">`;
                        popupContent += `<div class="popup-title">Hong Kong ${layerType}</div>`;
                        popupContent += '<div class="scrollable-content">';
                        popupContent += '<table class="property-table">';
                        
                        for (const [key, value] of Object.entries(feature.properties)) {
                            if (value !== null && value !== undefined && value !== '') {
                                popupContent += `<tr><td class="prop-key">${key}</td><td class="prop-value">${value}</td></tr>`;
                            }
                        }
                        
                        popupContent += '</table></div>';
                        
                        if (isMobile) {
                            popupContent += '<button onclick="togglePopupExpand()" class="popup-expand-btn" id="popup-expand-btn">‚ñº Show More Details</button>';
                        }
                        
                        popupContent += '</div>';
                        
                        new mapboxgl.Popup()
                            .setLngLat(e.lngLat)
                            .setHTML(popupContent)
                            .addTo(map);
                        
                        isClickProcessing = false;
                        return;
                    }
                }
                
                // Check if Seattle layer is visible
                const seattleParcelsLayer = map.getLayer('seattle-parcels-fill');
                const seattleParcelsVisible = seattleParcelsLayer && map.getLayoutProperty('seattle-parcels-fill', 'visibility') !== 'none';
                
                // Only query Seattle layers if click is within Seattle bounds
                if (seattleParcelsVisible && isInBounds(regionBounds.seattle)) {
                    const features = map.queryRenderedFeatures(e.point, { layers: ['seattle-parcels-fill'] });
                    
                    if (features.length > 0) {
                        const feature = features[0];
                        const isMobile = window.innerWidth <= 768;
                        
                        console.log('Seattle Mobile detection:', { isMobile, width: window.innerWidth });
                        
                        let popupContent = `<div class="popup-container ${isMobile ? 'compact' : ''}" id="popup-main">`;
                        popupContent += '<div class="popup-title">Seattle Parcel</div>';
                        popupContent += '<div class="scrollable-content">';
                        popupContent += '<table class="property-table">';
                        
                        for (const [key, value] of Object.entries(feature.properties)) {
                            if (value !== null && value !== undefined && value !== '') {
                                popupContent += `<tr><td class="prop-key">${key}</td><td class="prop-value">${value}</td></tr>`;
                            }
                        }
                        
                        popupContent += '</table></div>';
                        
                        if (isMobile) {
                            popupContent += '<button onclick="togglePopupExpand()" class="popup-expand-btn" id="popup-expand-btn">‚ñº Show More Details</button>';
                        }
                        
                        popupContent += '</div>';
                        
                        popupContent += '</table></div></div>';
                        
                        new mapboxgl.Popup()
                            .setLngLat(e.lngLat)
                            .setHTML(popupContent)
                            .addTo(map);
                        
                        isClickProcessing = false;
                        return;
                    }
                }
                
                // Check if Toronto layer is visible
                const torontoParcelsLayer = map.getLayer('toronto-parcels-fill');
                const torontoParcelsVisible = torontoParcelsLayer && map.getLayoutProperty('toronto-parcels-fill', 'visibility') !== 'none';
                
                // Only query Toronto layers if click is within Toronto bounds
                if (torontoParcelsVisible && isInBounds(regionBounds.toronto)) {
                    const features = map.queryRenderedFeatures(e.point, { layers: ['toronto-parcels-fill'] });
                    
                    if (features.length > 0) {
                        const feature = features[0];
                        const isMobile = window.innerWidth <= 768;
                        
                        console.log('Toronto Mobile detection:', { isMobile, width: window.innerWidth });
                        
                        let popupContent = `<div class="popup-container ${isMobile ? 'compact' : ''}" id="popup-main">`;
                        popupContent += '<div class="popup-title">Toronto Parcel</div>';
                        popupContent += '<div class="scrollable-content">';
                        popupContent += '<table class="property-table">';
                        
                        for (const [key, value] of Object.entries(feature.properties)) {
                            if (value !== null && value !== undefined && value !== '') {
                                popupContent += `<tr><td class="prop-key">${key}</td><td class="prop-value">${value}</td></tr>`;
                            }
                        }
                        
                        popupContent += '</table></div>';
                        
                        if (isMobile) {
                            popupContent += '<button onclick="togglePopupExpand()" class="popup-expand-btn" id="popup-expand-btn">‚ñº Show More Details</button>';
                        }
                        
                        popupContent += '</div>';
                        
                        new mapboxgl.Popup()
                            .setLngLat(e.lngLat)
                            .setHTML(popupContent)
                            .addTo(map);
                        
                        isClickProcessing = false;
                        return;
                    }
                }
                
                // Check if BC Canada layer is visible
                const bcParcelsLayer = map.getLayer('bc-parcels-fill');
                const bcParcelsVisible = bcParcelsLayer && map.getLayoutProperty('bc-parcels-fill', 'visibility') !== 'none';
                
                // Only query BC PMTiles if layer is visible AND click is within BC bounds
                if (bcParcelsVisible && isInBounds(regionBounds.bc)) {
                    const bcFeatures = map.queryRenderedFeatures(e.point, {
                        layers: ['bc-parcels-fill']
                    });
                    
                    if (bcFeatures.length > 0) {
                        const feature = bcFeatures[0];
                        const isMobile = window.innerWidth <= 768;
                        
                        let popupContent = `<div class="popup-container ${isMobile ? 'compact' : ''}" id="popup-main">`;
                        popupContent += '<div class="popup-title">BC Canada Parcel</div>';
                        popupContent += '<div class="scrollable-content">';
                        popupContent += '<table class="property-table">';
                        
                        for (const [key, value] of Object.entries(feature.properties)) {
                            if (value !== null && value !== undefined && value !== '') {
                                popupContent += `<tr><td class="prop-key">${key}</td><td class="prop-value">${value}</td></tr>`;
                            }
                        }
                        
                        popupContent += '</table></div>';
                        
                        if (isMobile) {
                            popupContent += '<button onclick="togglePopupExpand()" class="popup-expand-btn" id="popup-expand-btn">‚ñº Show More Details</button>';
                        }
                        
                        popupContent += '</div>';
                        
                        new mapboxgl.Popup()
                            .setLngLat(e.lngLat)
                            .setHTML(popupContent)
                            .addTo(map);
                        
                        isClickProcessing = false;
                        return;
                    }
                }
                
                // Query Philadelphia WMS only if click is within Philadelphia bounds
                if (isInBounds(regionBounds.philadelphia)) {
                    queryPhiladelphiaWMS();
                } else {
                    // Click is outside all known regions
                    isClickProcessing = false;
                }
                
                function queryPhiladelphiaWMS() {
                    // Use geographic coordinates instead of pixel coordinates
                    const tryFeatureInfo = () => {
                    // Use extremely small bbox for pinpoint parcel selection (~0.3m x 0.3m)
                    const bboxSize = MAP_CONFIG.BBOX_PRECISION;
                    const featureInfoUrl = 'https://mapservices.pasda.psu.edu/server/services/pasda/CityPhilly/MapServer/WMSServer?' +
                        'SERVICE=WMS&REQUEST=GetFeatureInfo&VERSION=1.1.1&LAYERS=16&QUERY_LAYERS=16' +
                        '&STYLES=&FORMAT=image/png&INFO_FORMAT=text/html' +
                        '&SRS=EPSG:4326' +
                        `&BBOX=${lng-bboxSize},${lat-bboxSize},${lng+bboxSize},${lat+bboxSize}` +
                        `&WIDTH=1&HEIGHT=1` +
                        `&X=0&Y=0` +
                        '&FEATURE_COUNT=10';
                    
                    return fetch(featureInfoUrl)
                        .then(response => response.text())
                        .then(text => {
                            console.log(`WMS response for coordinates (${lng},${lat}):`, text);
                            console.log(`Response length: ${text.length} characters`);
                            console.log(`Contains table data: ${text.includes('<td>') || text.includes('<tr>')}`);
                            
                            // Always show a popup for debugging - either data or debug info
                            if (text.includes('<td>') || text.includes('<tr>')) {
                                // Parse multiple features from table data
                                const parser = new DOMParser();
                                const doc = parser.parseFromString(text, 'text/html');
                                const table = doc.querySelector('table');
                                
                                if (table) {
                                    const rows = table.querySelectorAll('tr');
                                    let headers = [];
                                    let features = [];
                                    
                                    // Extract headers and all feature rows
                                    rows.forEach((row, rowIndex) => {
                                        const cells = row.querySelectorAll('td, th');
                                        if (rowIndex === 0) {
                                            // First row contains headers
                                            cells.forEach((cell, cellIndex) => {
                                                headers[cellIndex] = cell.textContent.trim();
                                            });
                                        } else {
                                            // Data rows contain feature values
                                            let feature = {};
                                            cells.forEach((cell, cellIndex) => {
                                                if (headers[cellIndex]) {
                                                    feature[headers[cellIndex]] = cell.textContent.trim();
                                                }
                                            });
                                            if (Object.keys(feature).length > 0) {
                                                features.push(feature);
                                            }
                                        }
                                    });
                                    
                                    // Create popup content based on number of features
                                    let popupContent = '<div class="popup-container">';
                                    
                                    if (features.length === 1) {
                                        // Single feature - display with grouped structure
                                        const feature = features[0];
                                        const groupedProps = groupProperties(feature);
                                        
                                        popupContent += '<div class="popup-title">Parcel Information</div>';
                                        popupContent += '<div class="scrollable-content">';
                                        
                                        let groupIndex = 0;
                                        for (const [groupName, properties] of Object.entries(groupedProps)) {
                                            const groupId = `single-group-${groupIndex}`;
                                            const isFirst = groupIndex === 0;
                                            
                                            popupContent += `<div class="property-group">`;
                                            popupContent += `<div class="group-header ${!isFirst ? 'collapsed' : ''}" id="${groupId}-header" onclick="toggleGroup('${groupId}')">`;
                                            popupContent += `<span>${groupName} (${Object.keys(properties).length})</span>`;
                                            popupContent += `<span class="group-icon" id="${groupId}-icon">${isFirst ? '‚ñº' : '‚ñ∂'}</span>`;
                                            popupContent += `</div>`;
                                            popupContent += `<div class="group-content ${!isFirst ? 'collapsed' : ''}" id="${groupId}-content">`;
                                            popupContent += `<div class="table-wrapper">`;
                                            popupContent += `<table class="group-table">`;
                                            
                                            for (const [key, value] of Object.entries(properties)) {
                                                const truncatedValue = createTruncatedContent(value);
                                                popupContent += `<tr><td>${key}</td><td>${truncatedValue}</td></tr>`;
                                            }
                                            
                                            popupContent += `</table></div></div></div>`;
                                            groupIndex++;
                                        }
                                        
                                        popupContent += '</div>';
                                    } else if (features.length > 1) {
                                        // Multiple features - create selection interface
                                        popupContent += `<div class="popup-title">Multiple Parcels Found (${features.length})</div>`;
                                        popupContent += '<div class="scrollable-content">';
                                        
                                        features.forEach((feature, index) => {
                                            const tencode = feature.TENCODE || feature.tencode || feature.Tencode || 'N/A';
                                            const address = feature.ADDRESS || feature.address || feature.Address || 'No Address';
                                            
                                            popupContent += `<div class="selection-card" onclick="showFeatureDetails(${index})">`;
                                            popupContent += `<div class="selection-card-title">TENCODE: ${tencode}</div>`;
                                            popupContent += `<div class="selection-card-subtitle">Address: ${address}</div>`;
                                            popupContent += '<div class="selection-card-hint">Click to view full details</div>';
                                            popupContent += '</div>';
                                        });
                                        
                                        popupContent += '</div>';
                                        
                                        // Store features data globally for selection
                                        window.currentFeatures = features;
                                        window.currentLngLat = e.lngLat;
                                    } else {
                                        popupContent += '<div class="no-data">No parcel data found</div>';
                                    }
                                    
                                    popupContent += '</div>';
                                    
                                    new mapboxgl.Popup()
                                        .setLngLat(e.lngLat)
                                        .setHTML(popupContent)
                                        .addTo(map);
                                } else {
                                    let popupContent = '<div class="popup-container">';
                                    popupContent += '<div class="popup-title">Parcel Information</div>';
                                    popupContent += '<div class="no-data">No structured data found</div>';
                                    popupContent += '</div>';
                                    
                                    new mapboxgl.Popup()
                                        .setLngLat(e.lngLat)
                                        .setHTML(popupContent)
                                        .addTo(map);
                                }
                            } else {
                                // Show debug info even when no table data
                                new mapboxgl.Popup()
                                    .setLngLat(e.lngLat)
                                    .setHTML(`<div class="popup-container">
                                        <div class="popup-title">Debug Info (${lng.toFixed(6)},${lat.toFixed(6)})</div>
                                        <div class="scrollable-content" style="max-height: 200px; font-size: 11px;">
                                            <table class="property-table">
                                                <tr><td>URL</td><td style="word-break: break-all;">${featureInfoUrl}</td></tr>
                                                <tr><td>Response Length</td><td>${text.length}</td></tr>
                                                <tr><td>Response Preview</td><td style="word-break: break-all;">${text.substring(0, 300)}...</td></tr>
                                            </table>
                                        </div>
                                    </div>`)
                                    .addTo(map);
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching feature info:', error);
                            new mapboxgl.Popup()
                                .setLngLat(e.lngLat)
                                .setHTML(`<div class="popup-container">
                                    <div class="popup-title">Error</div>
                                    <div class="no-data">Error: ${error.message}</div>
                                </div>`)
                                .addTo(map);
                        })
                        .finally(() => {
                            // Reset flag after processing is complete
                            isClickProcessing = false;
                        });
                };
                
                tryFeatureInfo();
                } // End of queryPhiladelphiaWMS function
                
            } // End of zoom level check
        }); // End of map click handler

        // Change cursor to pointer when hovering over the map
        map.on('mouseenter', () => {
            map.getCanvas().style.cursor = 'pointer';
        });
        map.on('mouseleave', () => {
            map.getCanvas().style.cursor = '';
        });

    // Layer toggle controls
    document.getElementById('philly-toggle').addEventListener('change', function(e) {
        const visibility = e.target.checked ? 'visible' : 'none';
        map.setLayoutProperty('philly-parcels-wms-layer', 'visibility', visibility);
    });

    document.getElementById('hk-parcels-toggle').addEventListener('change', function(e) {
        const visibility = e.target.checked ? 'visible' : 'none';
        map.setLayoutProperty('hk-parcels-fill', 'visibility', visibility);
        map.setLayoutProperty('hk-parcels-outline', 'visibility', visibility);
    });

    document.getElementById('hk-buildings-toggle').addEventListener('change', function(e) {
        const visibility = e.target.checked ? 'visible' : 'none';
        map.setLayoutProperty('hk-buildings-fill', 'visibility', visibility);
        map.setLayoutProperty('hk-buildings-outline', 'visibility', visibility);
    });
    
    document.getElementById('bc-parcels-toggle').addEventListener('change', function(e) {
        const visibility = e.target.checked ? 'visible' : 'none';
        if (map.getLayer('bc-parcels-fill')) {
            map.setLayoutProperty('bc-parcels-fill', 'visibility', visibility);
            map.setLayoutProperty('bc-parcels-outline', 'visibility', visibility);
        }
    });
    
    document.getElementById('seattle-parcels-toggle').addEventListener('change', function(e) {
        const visibility = e.target.checked ? 'visible' : 'none';
        if (map.getLayer('seattle-parcels-fill')) {
            map.setLayoutProperty('seattle-parcels-fill', 'visibility', visibility);
            map.setLayoutProperty('seattle-parcels-outline', 'visibility', visibility);
        }
    });
    
    document.getElementById('toronto-parcels-toggle').addEventListener('change', function(e) {
        const visibility = e.target.checked ? 'visible' : 'none';
        if (map.getLayer('toronto-parcels-fill')) {
            map.setLayoutProperty('toronto-parcels-fill', 'visibility', visibility);
            map.setLayoutProperty('toronto-parcels-outline', 'visibility', visibility);
        }
    });

    // Location navigation buttons
    document.getElementById('goto-philly').addEventListener('click', function() {
        map.flyTo({
            center: [-75.163471, 39.952583],
            zoom: 14,
            essential: true
        });
    });

    document.getElementById('goto-hk').addEventListener('click', function() {
        map.flyTo({
            center: [114.17, 22.31],
            zoom: 14,
            essential: true
        });
    });
    
    document.getElementById('goto-bc').addEventListener('click', function() {
        map.flyTo({
            center: [-123.1139, 49.2827], // Vancouver City Hall
            zoom: 14,
            essential: true
        });
    });
    
    document.getElementById('goto-seattle').addEventListener('click', function() {
        map.flyTo({
            center: [-122.3321, 47.6062],
            zoom: 13,
            essential: true
        });
    });
    
    document.getElementById('goto-toronto').addEventListener('click', function() {
        map.flyTo({
            center: [-79.3832, 43.6532], // Toronto City Hall
            zoom: 13,
            essential: true
        });
    });
    
    document.getElementById('goto-home').addEventListener('click', function() {
        map.flyTo({
            center: [-20, 35], // World view
            zoom: 2,
            essential: true
        });
    });
</script>
</body>
</html>
